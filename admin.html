<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Sistema Semanário</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .fade-in { animation: fadeIn 0.6s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .pulse-notification { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .status-ativo { background: linear-gradient(135deg, #10b981, #059669); }
        .status-pausado { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .status-removido { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .status-vencido { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .priority-alta { border-left: 4px solid #ef4444; }
        .priority-media { border-left: 4px solid #f59e0b; }
        .priority-baixa { border-left: 4px solid #10b981; }
        .priority-critica { border-left: 4px solid #dc2626; background-color: #fef2f2; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                            <i class="fas fa-crown text-red-600 text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white">Dashboard Admin</h1>
                            <p class="text-red-100 text-sm">Sistema de Gestão Completa</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- Quick Access Buttons -->
                    <div class="flex space-x-2">
                        <button onclick="accessProfessor()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg text-sm transition-all duration-200" title="Acessar como Professor">
                            <i class="fas fa-chalkboard-teacher mr-1"></i>
                            Professor
                        </button>
                        <button onclick="accessCoordenador()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg text-sm transition-all duration-200" title="Acessar como Coordenador">
                            <i class="fas fa-user-graduate mr-1"></i>
                            Coordenador
                        </button>
                        <button onclick="accessDiretor()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-3 py-2 rounded-lg text-sm transition-all duration-200" title="Acessar como Diretor">
                            <i class="fas fa-user-tie mr-1"></i>
                            Diretor
                        </button>
                    </div>
                    
                    <!-- Notification Bell -->
                    <div class="relative">
                        <button id="notificationBtn" onclick="toggleNotifications()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white p-2 rounded-lg transition-all duration-200 relative">
                            <i class="fas fa-bell text-lg"></i>
                            <span id="notificationBadge" class="hidden absolute -top-1 -right-1 bg-yellow-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center pulse-notification">0</span>
                        </button>
                        
                        <!-- Notifications Dropdown -->
                        <div id="notificationsDropdown" class="hidden absolute right-0 mt-2 w-96 bg-white rounded-lg shadow-xl z-50 border border-gray-200">
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="font-semibold text-gray-900">Recados das Escolas</h3>
                            </div>
                            <div id="notificationsList" class="max-h-64 overflow-y-auto">
                                <!-- Notifications will be loaded here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-right">
                        <p class="text-white font-medium" id="userName">Administrador</p>
                        <p class="text-red-100 text-sm">Sistema Master</p>
                    </div>
                    <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition-all duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>
                        Sair
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 card-hover fade-in">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100">
                        <i class="fas fa-school text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Escolas Ativas</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalEscolas">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 card-hover fade-in">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100">
                        <i class="fas fa-users text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Usuários Ativos</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalUsuarios">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 card-hover fade-in">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Vencendo (30 dias)</p>
                        <p class="text-2xl font-bold text-gray-900" id="vencendo30Dias">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 card-hover fade-in">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100">
                        <i class="fas fa-times-circle text-red-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Vencidos</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalVencidos">0</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 card-hover fade-in">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100">
                        <i class="fas fa-envelope text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Recados Recebidos</p>
                        <p class="text-2xl font-bold text-gray-900" id="totalRecados">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8 fade-in">
            <div class="flex flex-col sm:flex-row gap-4 items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900 mb-1">Ações Rápidas</h2>
                    <p class="text-gray-600">Gerencie escolas, usuários e monitore o sistema</p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <button onclick="openEscolaModal()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        Nova Escola
                    </button>
                    <button onclick="openUsuarioModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>
                        Novo Usuário
                    </button>
                    <button onclick="checkVencimentos()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-calendar-check mr-2"></i>
                        Verificar Vencimentos
                    </button>
                    <button onclick="sendWhatsAppNotifications()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fab fa-whatsapp mr-2"></i>
                        Enviar Notificações
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-sm mb-8 fade-in">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button onclick="switchTab('escolas')" id="tab-escolas" class="py-4 px-1 border-b-2 border-red-500 font-medium text-sm text-red-600">
                        <i class="fas fa-school mr-2"></i>
                        Escolas
                    </button>
                    <button onclick="switchTab('usuarios')" id="tab-usuarios" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-users mr-2"></i>
                        Usuários
                    </button>
                    <button onclick="switchTab('recados')" id="tab-recados" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-envelope mr-2"></i>
                        Recados
                    </button>
                    <button onclick="switchTab('vencimentos')" id="tab-vencimentos" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-calendar-times mr-2"></i>
                        Vencimentos
                    </button>
                    <button onclick="switchTab('whatsapp')" id="tab-whatsapp" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fab fa-whatsapp mr-2"></i>
                        WhatsApp
                    </button>
                    <button onclick="switchTab('logs')" id="tab-logs" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i class="fas fa-history mr-2"></i>
                        Logs
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="p-6">
                <!-- Escolas Tab -->
                <div id="content-escolas" class="tab-content">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Gestão de Escolas</h3>
                        <button onclick="openEscolaModal()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-plus mr-2"></i>
                            Nova Escola
                        </button>
                    </div>

                    <div id="loadingEscolas" class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <i class="fas fa-spinner loading-spinner text-3xl text-red-600 mb-4"></i>
                            <p class="text-gray-600">Carregando escolas...</p>
                        </div>
                    </div>

                    <div id="escolasList" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Escolas will be loaded here -->
                    </div>
                </div>

                <!-- Usuários Tab -->
                <div id="content-usuarios" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Gestão de Usuários</h3>
                        <div class="flex space-x-3">
                            <select id="escolaFilterUsuarios" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">Todas as escolas</option>
                            </select>
                            <select id="tipoFilterUsuarios" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">Todos os tipos</option>
                                <option value="professor">Professor</option>
                                <option value="coordenacao">Coordenação</option>
                                <option value="direcao">Direção</option>
                            </select>
                            <button onclick="openUsuarioModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-user-plus mr-2"></i>
                                Novo Usuário
                            </button>
                        </div>
                    </div>

                    <div id="loadingUsuarios" class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <i class="fas fa-spinner loading-spinner text-3xl text-blue-600 mb-4"></i>
                            <p class="text-gray-600">Carregando usuários...</p>
                        </div>
                    </div>

                    <div id="usuariosList" class="hidden space-y-4">
                        <!-- Usuários will be loaded here -->
                    </div>
                </div>

                <!-- Recados Tab -->
                <div id="content-recados" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Recados das Escolas</h3>
                        <div class="flex space-x-3">
                            <select id="prioridadeFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">Todas as prioridades</option>
                                <option value="baixa">Baixa</option>
                                <option value="media">Média</option>
                                <option value="alta">Alta</option>
                                <option value="critica">Crítica</option>
                            </select>
                            <select id="tipoSolicitacaoFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                <option value="">Todos os tipos</option>
                                <option value="correcao">Correção</option>
                                <option value="atualizacao">Atualização</option>
                                <option value="renovacao">Renovação</option>
                                <option value="suporte">Suporte</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                    </div>

                    <div id="loadingRecados" class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <i class="fas fa-spinner loading-spinner text-3xl text-purple-600 mb-4"></i>
                            <p class="text-gray-600">Carregando recados...</p>
                        </div>
                    </div>

                    <div id="recadosList" class="hidden space-y-4">
                        <!-- Recados will be loaded here -->
                    </div>
                </div>

                <!-- Vencimentos Tab -->
                <div id="content-vencimentos" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Controle de Vencimentos</h3>
                        <button onclick="checkVencimentos()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>
                            Atualizar
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Escolas Vencendo -->
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-yellow-900 mb-4">
                                <i class="fas fa-school mr-2"></i>
                                Escolas Vencendo (30 dias)
                            </h4>
                            <div id="escolasVencendo" class="space-y-3">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>

                        <!-- Usuários Vencendo -->
                        <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-red-900 mb-4">
                                <i class="fas fa-users mr-2"></i>
                                Usuários Vencidos
                            </h4>
                            <div id="usuariosVencidos" class="space-y-3">
                                <!-- Content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- WhatsApp Tab -->
                <div id="content-whatsapp" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Notificações WhatsApp</h3>
                        <div class="flex space-x-3">
                            <button onclick="sendWhatsAppNotifications()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fab fa-whatsapp mr-2"></i>
                                Enviar Notificações
                            </button>
                            <button onclick="openWhatsAppModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Envio Manual
                            </button>
                        </div>
                    </div>

                    <!-- WhatsApp Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 text-xl mr-3"></i>
                                <div>
                                    <p class="text-sm text-green-600">Enviados</p>
                                    <p class="text-xl font-bold text-green-900" id="whatsappEnviados">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-clock text-yellow-600 text-xl mr-3"></i>
                                <div>
                                    <p class="text-sm text-yellow-600">Pendentes</p>
                                    <p class="text-xl font-bold text-yellow-900" id="whatsappPendentes">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-times-circle text-red-600 text-xl mr-3"></i>
                                <div>
                                    <p class="text-sm text-red-600">Erros</p>
                                    <p class="text-xl font-bold text-red-900" id="whatsappErros">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <div class="flex items-center">
                                <i class="fas fa-chart-line text-blue-600 text-xl mr-3"></i>
                                <div>
                                    <p class="text-sm text-blue-600">Este Mês</p>
                                    <p class="text-xl font-bold text-blue-900" id="whatsappMes">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="loadingWhatsApp" class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <i class="fas fa-spinner loading-spinner text-3xl text-green-600 mb-4"></i>
                            <p class="text-gray-600">Carregando histórico WhatsApp...</p>
                        </div>
                    </div>

                    <div id="whatsappList" class="hidden space-y-4">
                        <!-- WhatsApp notifications will be loaded here -->
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="content-logs" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Logs de Atividades</h3>
                        <select id="acaoFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            <option value="">Todas as ações</option>
                            <option value="criar">Criar</option>
                            <option value="editar">Editar</option>
                            <option value="pausar">Pausar</option>
                            <option value="remover">Remover</option>
                            <option value="reativar">Reativar</option>
                        </select>
                    </div>

                    <div id="loadingLogs" class="flex items-center justify-center py-12">
                        <div class="text-center">
                            <i class="fas fa-spinner loading-spinner text-3xl text-gray-600 mb-4"></i>
                            <p class="text-gray-600">Carregando logs...</p>
                        </div>
                    </div>

                    <div id="logsList" class="hidden space-y-4">
                        <!-- Logs will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Escola Modal -->
    <div id="escolaModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="escolaModalTitle">
                        <i class="fas fa-school mr-2 text-red-600"></i>
                        Nova Escola
                    </h3>
                    <button onclick="closeEscolaModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="escolaForm" class="p-6 space-y-6">
                <input type="hidden" id="escolaId" name="escolaId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="nomeEscola" class="block text-sm font-medium text-gray-700 mb-2">Nome da Escola *</label>
                        <input type="text" id="nomeEscola" name="nomeEscola" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="emailEscola" class="block text-sm font-medium text-gray-700 mb-2">Email da Escola</label>
                        <input type="email" id="emailEscola" name="emailEscola" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent">
                    </div>
                </div>

                <div>
                    <label for="enderecoEscola" class="block text-sm font-medium text-gray-700 mb-2">Endereço Completo</label>
                    <textarea id="enderecoEscola" name="enderecoEscola" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Rua, número, bairro, cidade, CEP..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="telefoneEscola" class="block text-sm font-medium text-gray-700 mb-2">Telefone da Escola</label>
                        <input type="tel" id="telefoneEscola" name="telefoneEscola" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="(11) 99999-9999">
                    </div>
                    
                    <div>
                        <label for="planoEscola" class="block text-sm font-medium text-gray-700 mb-2">Plano Contratado *</label>
                        <select id="planoEscola" name="planoEscola" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            <option value="basico">Básico</option>
                            <option value="intermediario">Intermediário</option>
                            <option value="avancado">Avançado</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Dados do Diretor</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="diretorNome" class="block text-sm font-medium text-gray-700 mb-2">Nome do Diretor *</label>
                            <input type="text" id="diretorNome" name="diretorNome" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="diretorWhatsapp" class="block text-sm font-medium text-gray-700 mb-2">WhatsApp do Diretor</label>
                            <input type="tel" id="diretorWhatsapp" name="diretorWhatsapp" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="(11) 99999-9999">
                        </div>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                    <h4 class="text-lg font-semibold text-gray-900 mb-4">Dados do Contrato</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="dataContrato" class="block text-sm font-medium text-gray-700 mb-2">Data do Contrato *</label>
                            <input type="date" id="dataContrato" name="dataContrato" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="dataVencimentoEscola" class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento *</label>
                            <input type="date" id="dataVencimentoEscola" name="dataVencimentoEscola" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        </div>
                    </div>
                </div>

                <div>
                    <label for="observacoesEscola" class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                    <textarea id="observacoesEscola" name="observacoesEscola" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Observações sobre a escola, contrato, etc..."></textarea>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeEscolaModal()" class="flex-1 border border-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" id="salvarEscolaBtn" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg transition-colors">
                        <span id="salvarEscolaText">Salvar Escola</span>
                        <span id="salvarEscolaLoading" class="hidden">
                            <i class="fas fa-spinner loading-spinner mr-2"></i>
                            Salvando...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Usuario Modal -->
    <div id="usuarioModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900" id="usuarioModalTitle">
                        <i class="fas fa-user-plus mr-2 text-blue-600"></i>
                        Novo Usuário
                    </h3>
                    <button onclick="closeUsuarioModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="usuarioForm" class="p-6 space-y-6">
                <input type="hidden" id="usuarioId" name="usuarioId">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="nomeUsuario" class="block text-sm font-medium text-gray-700 mb-2">Nome Completo *</label>
                        <input type="text" id="nomeUsuario" name="nomeUsuario" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="emailUsuario" class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                        <input type="email" id="emailUsuario" name="emailUsuario" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="whatsappUsuario" class="block text-sm font-medium text-gray-700 mb-2">WhatsApp</label>
                        <input type="tel" id="whatsappUsuario" name="whatsappUsuario" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="(11) 99999-9999">
                    </div>
                    
                    <div>
                        <label for="tipoUsuario" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuário *</label>
                        <select id="tipoUsuario" name="tipoUsuario" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecione o tipo</option>
                            <option value="professor">Professor</option>
                            <option value="coordenacao">Coordenação</option>
                            <option value="direcao">Direção</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="escolaUsuario" class="block text-sm font-medium text-gray-700 mb-2">Escola *</label>
                        <select id="escolaUsuario" name="escolaUsuario" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Selecione a escola</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="statusUsuario" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="statusUsuario" name="statusUsuario" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="ativo">Ativo</option>
                            <option value="pausado">Pausado</option>
                            <option value="removido">Removido</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="dataMatricula" class="block text-sm font-medium text-gray-700 mb-2">Data de Matrícula *</label>
                        <input type="date" id="dataMatricula" name="dataMatricula" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="dataVencimentoUsuario" class="block text-sm font-medium text-gray-700 mb-2">Data de Vencimento</label>
                        <input type="date" id="dataVencimentoUsuario" name="dataVencimentoUsuario" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div>
                    <label for="observacoesUsuario" class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                    <textarea id="observacoesUsuario" name="observacoesUsuario" rows="3" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Observações sobre o usuário..."></textarea>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeUsuarioModal()" class="flex-1 border border-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" id="salvarUsuarioBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors">
                        <span id="salvarUsuarioText">Salvar Usuário</span>
                        <span id="salvarUsuarioLoading" class="hidden">
                            <i class="fas fa-spinner loading-spinner mr-2"></i>
                            Salvando...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- WhatsApp Manual Modal -->
    <div id="whatsappModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fab fa-whatsapp mr-2 text-green-600"></i>
                        Envio Manual WhatsApp
                    </h3>
                    <button onclick="closeWhatsAppModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="whatsappForm" class="p-6 space-y-6">
                <div>
                    <label for="destinatarioWhatsApp" class="block text-sm font-medium text-gray-700 mb-2">Destinatário *</label>
                    <select id="destinatarioWhatsApp" name="destinatarioWhatsApp" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">Selecione o destinatário</option>
                    </select>
                </div>

                <div>
                    <label for="tipoMensagem" class="block text-sm font-medium text-gray-700 mb-2">Tipo de Mensagem *</label>
                    <select id="tipoMensagem" name="tipoMensagem" required class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent">
                        <option value="">Selecione o tipo</option>
                        <option value="vencimento">Aviso de Vencimento</option>
                        <option value="renovacao">Renovação de Contrato</option>
                        <option value="boas-vindas">Boas-vindas</option>
                        <option value="suporte">Suporte Técnico</option>
                        <option value="personalizada">Mensagem Personalizada</option>
                    </select>
                </div>

                <div>
                    <label for="mensagemWhatsApp" class="block text-sm font-medium text-gray-700 mb-2">Mensagem *</label>
                    <textarea id="mensagemWhatsApp" name="mensagemWhatsApp" required rows="6" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Digite sua mensagem aqui..."></textarea>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex">
                        <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                        <div>
                            <h4 class="text-sm font-medium text-blue-800">Limite Mensal</h4>
                            <p class="text-sm text-blue-700 mt-1">
                                Você pode enviar até 1000 mensagens por mês gratuitamente.
                                <span id="mensagensRestantes" class="font-medium">Restam: 1000 mensagens</span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeWhatsAppModal()" class="flex-1 border border-gray-300 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" id="enviarWhatsAppBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition-colors">
                        <span id="enviarWhatsAppText">
                            <i class="fab fa-whatsapp mr-2"></i>
                            Enviar Mensagem
                        </span>
                        <span id="enviarWhatsAppLoading" class="hidden">
                            <i class="fas fa-spinner loading-spinner mr-2"></i>
                            Enviando...
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 bg-white border border-gray-200 rounded-lg shadow-lg p-4 transform translate-x-full transition-transform duration-300 z-50">
        <div class="flex items-center">
            <div id="toastIcon" class="mr-3"></div>
            <div>
                <p id="toastMessage" class="font-medium text-gray-900"></p>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://srqqheacsglhyyhvfchg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNycXFoZWFjc2dsaHl5aHZmY2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNTMxMDMsImV4cCI6MjA3MzcyOTEwM30.ZOKVDK1FEyDM-lcPrw4-0xbVDxYLftek3NHYcmjc_7w';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let activeTab = 'escolas';
        let currentEscola = null;
        let currentUsuario = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadInitialData();
            setupEventListeners();
            
            // Auto-refresh every 60 seconds
            setInterval(loadStats, 60000);
            setInterval(loadNotifications, 30000);
        });

        // Check authentication
        async function checkAuth() {
            // For demo purposes, we'll create a mock admin session
            // In production, this would check actual authentication
            currentUser = {
                id: 'admin-demo-id',
                email: 'admin@sistema.com',
                user_metadata: { name: 'Administrador' }
            };
        }

        // Load initial data
        async function loadInitialData() {
            await Promise.all([
                loadStats(),
                loadEscolas(),
                loadNotifications(),
                loadEscolasForSelect()
            ]);
        }

        // Load stats
        async function loadStats() {
            try {
                // Total escolas ativas
                const { data: escolas, error: escolasError } = await supabase
                    .from('schools')
                    .select('id')
                    .eq('status_escola', 'ativa');

                if (escolasError) throw escolasError;

                // Total usuários ativos
                const { data: usuarios, error: usuariosError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('status_usuario', 'ativo')
                    .neq('user_type', 'admin');

                if (usuariosError) throw usuariosError;

                // Vencendo em 30 dias
                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                
                const { data: vencendo, error: vencendoError } = await supabase
                    .from('users')
                    .select('id')
                    .lte('data_vencimento', thirtyDaysFromNow.toISOString().split('T')[0])
                    .gte('data_vencimento', new Date().toISOString().split('T')[0])
                    .eq('status_usuario', 'ativo');

                if (vencendoError) throw vencendoError;

                // Vencidos
                const { data: vencidos, error: vencidosError } = await supabase
                    .from('users')
                    .select('id')
                    .lt('data_vencimento', new Date().toISOString().split('T')[0])
                    .eq('status_usuario', 'ativo');

                if (vencidosError) throw vencidosError;

                // Recados recebidos (últimos 30 dias)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const { data: recados, error: recadosError } = await supabase
                    .from('recados')
                    .select('id')
                    .eq('tipo', 'admin')
                    .gte('created_at', thirtyDaysAgo.toISOString());

                if (recadosError) throw recadosError;

                // Update stats
                document.getElementById('totalEscolas').textContent = escolas?.length || 0;
                document.getElementById('totalUsuarios').textContent = usuarios?.length || 0;
                document.getElementById('vencendo30Dias').textContent = vencendo?.length || 0;
                document.getElementById('totalVencidos').textContent = vencidos?.length || 0;
                document.getElementById('totalRecados').textContent = recados?.length || 0;

            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        // Load escolas
        async function loadEscolas() {
            const loadingDiv = document.getElementById('loadingEscolas');
            const listDiv = document.getElementById('escolasList');

            loadingDiv.classList.remove('hidden');
            listDiv.classList.add('hidden');

            try {
                const { data: escolas, error } = await supabase
                    .from('schools')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                renderEscolas(escolas || []);
                listDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Erro ao carregar escolas:', error);
                showToast('Erro ao carregar escolas', 'error');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        // Render escolas
        function renderEscolas(escolas) {
            const container = document.getElementById('escolasList');
            container.innerHTML = '';

            if (escolas.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-school text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhuma escola cadastrada</h3>
                        <p class="text-gray-600">Comece cadastrando a primeira escola.</p>
                    </div>
                `;
                return;
            }

            escolas.forEach(escola => {
                const statusInfo = getStatusEscolaInfo(escola.status_escola, escola.data_vencimento_escola);
                const isVencida = escola.data_vencimento_escola && new Date(escola.data_vencimento_escola) < new Date();
                
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-6 card-hover';
                
                div.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-school text-red-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${escola.name}</h3>
                                <p class="text-sm text-gray-600">${escola.diretor_nome || 'Diretor não informado'}</p>
                            </div>
                        </div>
                        ${statusInfo.html}
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        ${escola.endereco ? `
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>${escola.endereco}</span>
                            </div>
                        ` : ''}
                        ${escola.telefone ? `
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <i class="fas fa-phone"></i>
                                <span>${escola.telefone}</span>
                            </div>
                        ` : ''}
                        ${escola.email ? `
                            <div class="flex items-center space-x-2 text-sm text-gray-600">
                                <i class="fas fa-envelope"></i>
                                <span>${escola.email}</span>
                            </div>
                        ` : ''}
                        <div class="flex items-center space-x-2 text-sm text-gray-600">
                            <i class="fas fa-calendar"></i>
                            <span>Plano: ${getPlanoName(escola.plano)} ${escola.data_vencimento_escola ? `- Vence: ${new Date(escola.data_vencimento_escola).toLocaleDateString('pt-BR')}` : ''}</span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button 
                            onclick="editEscola('${escola.id}')"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-sm transition-colors"
                        >
                            <i class="fas fa-edit mr-1"></i>
                            Editar
                        </button>
                        ${escola.status_escola === 'ativa' ? `
                            <button 
                                onclick="pausarEscola('${escola.id}')"
                                class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-3 rounded-lg text-sm transition-colors"
                            >
                                <i class="fas fa-pause mr-1"></i>
                                Pausar
                            </button>
                        ` : escola.status_escola === 'pausada' ? `
                            <button 
                                onclick="reativarEscola('${escola.id}')"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-sm transition-colors"
                            >
                                <i class="fas fa-play mr-1"></i>
                                Reativar
                            </button>
                        ` : ''}
                        <button 
                            onclick="removerEscola('${escola.id}')"
                            class="bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm transition-colors"
                        >
                            <i class="fas fa-trash mr-1"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Load escolas for select
        async function loadEscolasForSelect() {
            try {
                const { data: escolas, error } = await supabase
                    .from('schools')
                    .select('id, name')
                    .eq('status_escola', 'ativa')
                    .order('name');

                if (error) throw error;

                const selects = [
                    document.getElementById('escolaUsuario'),
                    document.getElementById('escolaFilterUsuarios')
                ];

                selects.forEach(select => {
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = select.id === 'escolaFilterUsuarios' ? 
                            '<option value="">Todas as escolas</option>' : 
                            '<option value="">Selecione a escola</option>';
                        
                        escolas.forEach(escola => {
                            const option = document.createElement('option');
                            option.value = escola.id;
                            option.textContent = escola.name;
                            select.appendChild(option);
                        });

                        if (currentValue) {
                            select.value = currentValue;
                        }
                    }
                });

            } catch (error) {
                console.error('Erro ao carregar escolas para select:', error);
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const { data: recados, error } = await supabase
                    .from('recados')
                    .select(`
                        *,
                        remetente:users!recados_remetente_id_fkey (name),
                        schools (name, endereco)
                    `)
                    .eq('tipo', 'admin')
                    .eq('lido', false)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                updateNotificationBadge(recados?.length || 0);
                renderNotifications(recados || []);

            } catch (error) {
                console.error('Erro ao carregar notificações:', error);
            }
        }

        // Update notification badge
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Render notifications
        function renderNotifications(recados) {
            const container = document.getElementById('notificationsList');
            container.innerHTML = '';

            if (recados.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-bell-slash text-2xl mb-2"></i>
                        <p>Nenhum recado novo</p>
                    </div>
                `;
                return;
            }

            recados.forEach(recado => {
                const date = new Date(recado.created_at).toLocaleDateString('pt-BR');
                
                const div = document.createElement('div');
                div.className = `p-4 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition-colors priority-${recado.prioridade}`;
                div.onclick = () => {
                    markAsRead(recado.id);
                    switchTab('recados');
                    toggleNotifications();
                };
                
                div.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 mt-1">
                            <i class="fas fa-${getPriorityIcon(recado.prioridade)} text-${getPriorityColor(recado.prioridade)}-500"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">
                                ${recado.assunto}
                            </p>
                            <p class="text-sm text-gray-600 truncate">
                                ${recado.remetente?.name} - ${recado.schools?.name}
                            </p>
                            <p class="text-sm text-gray-600 truncate">
                                ${getTipoSolicitacaoText(recado.tipo_solicitacao)}
                            </p>
                            <p class="text-xs text-gray-500 mt-1">${date}</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Get status escola info
        function getStatusEscolaInfo(status, dataVencimento) {
            const isVencida = dataVencimento && new Date(dataVencimento) < new Date();
            
            if (isVencida) {
                return {
                    html: `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
                        <i class="fas fa-times-circle mr-2"></i>
                        Vencida
                    </span>`
                };
            }

            const statusMap = {
                'ativa': {
                    html: `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
                        <i class="fas fa-check-circle mr-2"></i>
                        Ativa
                    </span>`
                },
                'pausada': {
                    html: `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800">
                        <i class="fas fa-pause-circle mr-2"></i>
                        Pausada
                    </span>`
                },
                'removida': {
                    html: `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
                        <i class="fas fa-times-circle mr-2"></i>
                        Removida
                    </span>`
                }
            };

            return statusMap[status] || statusMap.ativa;
        }

        // Get plano name
        function getPlanoName(plano) {
            const planos = {
                'basico': 'Básico',
                'intermediario': 'Intermediário',
                'avancado': 'Avançado',
                'premium': 'Premium'
            };
            return planos[plano] || 'Básico';
        }

        // Get priority icon
        function getPriorityIcon(priority) {
            const icons = {
                'baixa': 'info-circle',
                'media': 'exclamation-circle',
                'alta': 'exclamation-triangle',
                'critica': 'fire'
            };
            return icons[priority] || 'info-circle';
        }

        // Get priority color
        function getPriorityColor(priority) {
            const colors = {
                'baixa': 'blue',
                'media': 'yellow',
                'alta': 'orange',
                'critica': 'red'
            };
            return colors[priority] || 'blue';
        }

        // Get tipo solicitacao text
        function getTipoSolicitacaoText(tipo) {
            const texts = {
                'correcao': 'Correção de Bug',
                'atualizacao': 'Atualização',
                'renovacao': 'Renovação de Plano',
                'suporte': 'Suporte Técnico',
                'outro': 'Outro'
            };
            return texts[tipo] || 'Solicitação';
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('border-red-500', 'text-red-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });
            
            document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`tab-${tabName}`).classList.add('border-red-500', 'text-red-600');

            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            
            activeTab = tabName;

            // Load data for specific tabs
            if (tabName === 'usuarios') {
                loadUsuarios();
            } else if (tabName === 'recados') {
                loadRecados();
            } else if (tabName === 'vencimentos') {
                loadVencimentos();
            } else if (tabName === 'whatsapp') {
                loadWhatsApp();
            } else if (tabName === 'logs') {
                loadLogs();
            }
        }

        // Load usuarios
        async function loadUsuarios() {
            const loadingDiv = document.getElementById('loadingUsuarios');
            const listDiv = document.getElementById('usuariosList');

            loadingDiv.classList.remove('hidden');
            listDiv.classList.add('hidden');

            try {
                let query = supabase
                    .from('users')
                    .select(`
                        *,
                        schools (name)
                    `)
                    .neq('user_type', 'admin')
                    .order('created_at', { ascending: false });

                // Apply filters
                const escolaFilter = document.getElementById('escolaFilterUsuarios')?.value;
                const tipoFilter = document.getElementById('tipoFilterUsuarios')?.value;

                if (escolaFilter) {
                    query = query.eq('school_id', escolaFilter);
                }

                if (tipoFilter) {
                    query = query.eq('user_type', tipoFilter);
                }

                const { data: usuarios, error } = await query;

                if (error) throw error;

                renderUsuarios(usuarios || []);
                listDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                showToast('Erro ao carregar usuários', 'error');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        // Render usuarios
        function renderUsuarios(usuarios) {
            const container = document.getElementById('usuariosList');
            container.innerHTML = '';

            if (usuarios.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-users text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhum usuário encontrado</h3>
                        <p class="text-gray-600">Não há usuários com os filtros selecionados.</p>
                    </div>
                `;
                return;
            }

            usuarios.forEach(usuario => {
                const statusInfo = getStatusUsuarioInfo(usuario.status_usuario, usuario.data_vencimento);
                const isVencido = usuario.data_vencimento && new Date(usuario.data_vencimento) < new Date();
                
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow';
                
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-${getUserTypeIcon(usuario.user_type)} text-blue-600 text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${usuario.name}</h3>
                                <p class="text-sm text-gray-600">${usuario.email}</p>
                                <p class="text-sm text-gray-500">${getUserTypeName(usuario.user_type)} - ${usuario.schools?.name}</p>
                            </div>
                        </div>
                        ${statusInfo.html}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        ${usuario.whatsapp ? `
                            <div class="flex items-center space-x-2 text-gray-600">
                                <i class="fab fa-whatsapp"></i>
                                <span>${usuario.whatsapp}</span>
                            </div>
                        ` : '<div></div>'}
                        ${usuario.data_matricula ? `
                            <div class="flex items-center space-x-2 text-gray-600">
                                <i class="fas fa-calendar-plus"></i>
                                <span>Matrícula: ${new Date(usuario.data_matricula).toLocaleDateString('pt-BR')}</span>
                            </div>
                        ` : '<div></div>'}
                        ${usuario.data_vencimento ? `
                            <div class="flex items-center space-x-2 text-gray-600">
                                <i class="fas fa-calendar-times"></i>
                                <span>Vencimento: ${new Date(usuario.data_vencimento).toLocaleDateString('pt-BR')}</span>
                            </div>
                        ` : '<div></div>'}
                    </div>
                    
                    <div class="flex space-x-2">
                        <button 
                            onclick="editUsuario('${usuario.id}')"
                            class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-sm transition-colors"
                        >
                            <i class="fas fa-edit mr-1"></i>
                            Editar
                        </button>
                        ${usuario.status_usuario === 'ativo' ? `
                            <button 
                                onclick="pausarUsuario('${usuario.id}')"
                                class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white py-2 px-3 rounded-lg text-sm transition-colors"
                            >
                                <i class="fas fa-pause mr-1"></i>
                                Pausar
                            </button>
                        ` : usuario.status_usuario === 'pausado' ? `
                            <button 
                                onclick="reativarUsuario('${usuario.id}')"
                                class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-sm transition-colors"
                            >
                                <i class="fas fa-play mr-1"></i>
                                Reativar
                            </button>
                        ` : ''}
                        ${usuario.whatsapp ? `
                            <button 
                                onclick="sendWhatsAppToUser('${usuario.id}')"
                                class="bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-sm transition-colors"
                                title="Enviar WhatsApp"
                            >
                                <i class="fab fa-whatsapp"></i>
                            </button>
                        ` : ''}
                        <button 
                            onclick="removerUsuario('${usuario.id}')"
                            class="bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm transition-colors"
                        >
                            <i class="fas fa-trash mr-1"></i>
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Get status usuario info
        function getStatusUsuarioInfo(status, dataVencimento) {
            const isVencido = dataVencimento && new Date(dataVencimento) < new Date();
            
            if (isVencido) {
                return {
                    html: `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
                        <i class="fas fa-times-circle mr-2"></i>
                        Vencido
                    </span>`
                };
            }

            const statusMap = {
                'ativo': {
                    html: `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800">
                        <i class="fas fa-check-circle mr-2"></i>
                        Ativo
                    </span>`
                },
                'pausado': {
                    html: `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-yellow-100 text-yellow-800">
                        <i class="fas fa-pause-circle mr-2"></i>
                        Pausado
                    </span>`
                },
                'removido': {
                    html: `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-red-100 text-red-800">
                        <i class="fas fa-times-circle mr-2"></i>
                        Removido
                    </span>`
                }
            };

            return statusMap[status] || statusMap.ativo;
        }

        // Get user type icon
        function getUserTypeIcon(type) {
            const icons = {
                'professor': 'chalkboard-teacher',
                'coordenacao': 'user-graduate',
                'direcao': 'user-tie'
            };
            return icons[type] || 'user';
        }

        // Get user type name
        function getUserTypeName(type) {
            const names = {
                'professor': 'Professor',
                'coordenacao': 'Coordenação',
                'direcao': 'Direção'
            };
            return names[type] || type;
        }

        // Load recados
        async function loadRecados() {
            const loadingDiv = document.getElementById('loadingRecados');
            const listDiv = document.getElementById('recadosList');

            loadingDiv.classList.remove('hidden');
            listDiv.classList.add('hidden');

            try {
                let query = supabase
                    .from('recados')
                    .select(`
                        *,
                        remetente:users!recados_remetente_id_fkey (name),
                        schools (name, endereco, diretor_nome)
                    `)
                    .eq('tipo', 'admin')
                    .order('created_at', { ascending: false });

                // Apply filters
                const prioridadeFilter = document.getElementById('prioridadeFilter')?.value;
                const tipoFilter = document.getElementById('tipoSolicitacaoFilter')?.value;

                if (prioridadeFilter) {
                    query = query.eq('prioridade', prioridadeFilter);
                }

                if (tipoFilter) {
                    query = query.eq('tipo_solicitacao', tipoFilter);
                }

                const { data: recados, error } = await query;

                if (error) throw error;

                renderRecados(recados || []);
                listDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Erro ao carregar recados:', error);
                showToast('Erro ao carregar recados', 'error');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        // Render recados
        function renderRecados(recados) {
            const container = document.getElementById('recadosList');
            container.innerHTML = '';

            if (recados.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-envelope text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhum recado encontrado</h3>
                        <p class="text-gray-600">Não há recados com os filtros selecionados.</p>
                    </div>
                `;
                return;
            }

            recados.forEach(recado => {
                const div = document.createElement('div');
                div.className = `bg-white border border-gray-200 rounded-lg p-6 priority-${recado.prioridade} ${!recado.lido ? 'bg-blue-50' : ''}`;
                
                div.innerHTML = `
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-${getPriorityIcon(recado.prioridade)} text-purple-600"></i>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-900">${recado.assunto}</h3>
                                <p class="text-sm text-gray-600">
                                    ${recado.remetente?.name} - ${recado.schools?.diretor_nome || 'Diretor'}
                                </p>
                                <p class="text-sm text-gray-500">${recado.schools?.name}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getPriorityClass(recado.prioridade)}">
                                ${getPriorityText(recado.prioridade)}
                            </span>
                            <p class="text-xs text-gray-500 mt-1">${new Date(recado.created_at).toLocaleString('pt-BR')}</p>
                        </div>
                    </div>
                    
                    ${recado.schools?.endereco ? `
                        <div class="mb-3">
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-map-marker-alt mr-2"></i>
                                ${recado.schools.endereco}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="mb-4">
                        <p class="text-gray-700">${recado.mensagem}</p>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <span class="text-sm text-gray-500">
                                ${recado.lido ? 
                                    '<i class="fas fa-check-double text-green-500 mr-1"></i>Lido' : 
                                    '<i class="fas fa-clock text-yellow-500 mr-1"></i>Não lido'
                                }
                            </span>
                            <span class="text-sm text-purple-600">
                                <i class="fas fa-${recado.tipo_solicitacao === 'renovacao' ? 'credit-card' : 
                                    recado.tipo_solicitacao === 'correcao' ? 'bug' : 
                                    recado.tipo_solicitacao === 'atualizacao' ? 'sync' : 'question'} mr-1"></i>
                                ${getTipoSolicitacaoText(recado.tipo_solicitacao)}
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            ${!recado.lido ? `
                                <button 
                                    onclick="markAsRead('${recado.id}')"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition-colors"
                                >
                                    <i class="fas fa-check mr-1"></i>
                                    Marcar como lido
                                </button>
                            ` : ''}
                            ${recado.remetente?.whatsapp ? `
                                <button 
                                    onclick="replyWhatsApp('${recado.remetente.id}')"
                                    class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm transition-colors"
                                >
                                    <i class="fab fa-whatsapp mr-1"></i>
                                    Responder
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Get priority class
        function getPriorityClass(priority) {
            const classes = {
                'baixa': 'bg-green-100 text-green-800',
                'media': 'bg-yellow-100 text-yellow-800',
                'alta': 'bg-red-100 text-red-800',
                'critica': 'bg-red-200 text-red-900'
            };
            return classes[priority] || classes.media;
        }

        // Get priority text
        function getPriorityText(priority) {
            const texts = {
                'baixa': 'Baixa',
                'media': 'Média',
                'alta': 'Alta',
                'critica': 'Crítica'
            };
            return texts[priority] || 'Média';
        }

        // Load vencimentos
        async function loadVencimentos() {
            try {
                // Escolas vencendo em 30 dias
                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
                
                const { data: escolasVencendo, error: escolasError } = await supabase
                    .from('schools')
                    .select('*')
                    .lte('data_vencimento_escola', thirtyDaysFromNow.toISOString().split('T')[0])
                    .gte('data_vencimento_escola', new Date().toISOString().split('T')[0])
                    .eq('status_escola', 'ativa')
                    .order('data_vencimento_escola');

                if (escolasError) throw escolasError;

                // Usuários vencidos
                const { data: usuariosVencidos, error: usuariosError } = await supabase
                    .from('users')
                    .select(`
                        *,
                        schools (name)
                    `)
                    .lt('data_vencimento', new Date().toISOString().split('T')[0])
                    .eq('status_usuario', 'ativo')
                    .order('data_vencimento');

                if (usuariosError) throw usuariosError;

                renderVencimentos(escolasVencendo || [], usuariosVencidos || []);

            } catch (error) {
                console.error('Erro ao carregar vencimentos:', error);
                showToast('Erro ao carregar vencimentos', 'error');
            }
        }

        // Render vencimentos
        function renderVencimentos(escolasVencendo, usuariosVencidos) {
            // Render escolas vencendo
            const escolasContainer = document.getElementById('escolasVencendo');
            escolasContainer.innerHTML = '';

            if (escolasVencendo.length === 0) {
                escolasContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                        <p class="text-green-700">Nenhuma escola vencendo nos próximos 30 dias</p>
                    </div>
                `;
            } else {
                escolasVencendo.forEach(escola => {
                    const diasRestantes = Math.ceil((new Date(escola.data_vencimento_escola) - new Date()) / (1000 * 60 * 60 * 24));
                    
                    const div = document.createElement('div');
                    div.className = 'bg-white border border-yellow-300 rounded-lg p-4';
                    
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-900">${escola.name}</h4>
                                <p class="text-sm text-gray-600">Vence em ${diasRestantes} dias</p>
                                <p class="text-sm text-gray-500">${new Date(escola.data_vencimento_escola).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <div class="flex space-x-2">
                                ${escola.diretor_whatsapp ? `
                                    <button 
                                        onclick="sendRenewalWhatsApp('escola', '${escola.id}')"
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm"
                                    >
                                        <i class="fab fa-whatsapp mr-1"></i>
                                        Notificar
                                    </button>
                                ` : ''}
                                <button 
                                    onclick="editEscola('${escola.id}')"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"
                                >
                                    <i class="fas fa-edit mr-1"></i>
                                    Renovar
                                </button>
                            </div>
                        </div>
                    `;
                    escolasContainer.appendChild(div);
                });
            }

            // Render usuários vencidos
            const usuariosContainer = document.getElementById('usuariosVencidos');
            usuariosContainer.innerHTML = '';

            if (usuariosVencidos.length === 0) {
                usuariosContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-check-circle text-green-500 text-2xl mb-2"></i>
                        <p class="text-green-700">Nenhum usuário vencido</p>
                    </div>
                `;
            } else {
                usuariosVencidos.forEach(usuario => {
                    const diasVencido = Math.ceil((new Date() - new Date(usuario.data_vencimento)) / (1000 * 60 * 60 * 24));
                    
                    const div = document.createElement('div');
                    div.className = 'bg-white border border-red-300 rounded-lg p-4';
                    
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-900">${usuario.name}</h4>
                                <p class="text-sm text-gray-600">${usuario.schools?.name}</p>
                                <p class="text-sm text-red-600">Vencido há ${diasVencido} dias</p>
                                <p class="text-sm text-gray-500">${new Date(usuario.data_vencimento).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <div class="flex space-x-2">
                                ${usuario.whatsapp ? `
                                    <button 
                                        onclick="sendRenewalWhatsApp('usuario', '${usuario.id}')"
                                        class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm"
                                    >
                                        <i class="fab fa-whatsapp mr-1"></i>
                                        Notificar
                                    </button>
                                ` : ''}
                                <button 
                                    onclick="editUsuario('${usuario.id}')"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm"
                                >
                                    <i class="fas fa-edit mr-1"></i>
                                    Renovar
                                </button>
                                <button 
                                    onclick="pausarUsuario('${usuario.id}')"
                                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm"
                                >
                                    <i class="fas fa-pause mr-1"></i>
                                    Pausar
                                </button>
                            </div>
                        </div>
                    `;
                    usuariosContainer.appendChild(div);
                });
            }
        }

        // Load WhatsApp
        async function loadWhatsApp() {
            const loadingDiv = document.getElementById('loadingWhatsApp');
            const listDiv = document.getElementById('whatsappList');

            loadingDiv.classList.remove('hidden');
            listDiv.classList.add('hidden');

            try {
                // Load WhatsApp stats
                const { data: stats, error: statsError } = await supabase
                    .from('whatsapp_notifications')
                    .select('status');

                if (statsError) throw statsError;

                const enviados = stats?.filter(s => s.status === 'enviado').length || 0;
                const pendentes = stats?.filter(s => s.status === 'pendente').length || 0;
                const erros = stats?.filter(s => s.status === 'erro').length || 0;

                // This month
                const thisMonth = new Date();
                thisMonth.setDate(1);
                
                const { data: thisMonthStats, error: monthError } = await supabase
                    .from('whatsapp_notifications')
                    .select('id')
                    .gte('created_at', thisMonth.toISOString());

                if (monthError) throw monthError;

                document.getElementById('whatsappEnviados').textContent = enviados;
                document.getElementById('whatsappPendentes').textContent = pendentes;
                document.getElementById('whatsappErros').textContent = erros;
                document.getElementById('whatsappMes').textContent = thisMonthStats?.length || 0;

                // Load notifications history
                const { data: notifications, error } = await supabase
                    .from('whatsapp_notifications')
                    .select(`
                        *,
                        users (name, email)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                renderWhatsApp(notifications || []);
                listDiv.classList.remove('hidden');

                // Update remaining messages
                const remaining = Math.max(0, 1000 - (thisMonthStats?.length || 0));
                document.getElementById('mensagensRestantes').textContent = `Restam: ${remaining} mensagens`;

            } catch (error) {
                console.error('Erro ao carregar WhatsApp:', error);
                showToast('Erro ao carregar dados do WhatsApp', 'error');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        // Render WhatsApp
        function renderWhatsApp(notifications) {
            const container = document.getElementById('whatsappList');
            container.innerHTML = '';

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fab fa-whatsapp text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhuma notificação enviada</h3>
                        <p class="text-gray-600">Histórico de notificações WhatsApp aparecerá aqui.</p>
                    </div>
                `;
                return;
            }

            notifications.forEach(notification => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-4';
                
                const statusIcon = {
                    'enviado': 'check-circle text-green-500',
                    'pendente': 'clock text-yellow-500',
                    'erro': 'times-circle text-red-500'
                };

                const statusText = {
                    'enviado': 'Enviado',
                    'pendente': 'Pendente',
                    'erro': 'Erro'
                };
                
                div.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-${statusIcon[notification.status]} text-xl"></i>
                            <div>
                                <h4 class="font-medium text-gray-900">${notification.users?.name}</h4>
                                <p class="text-sm text-gray-600">${notification.numero_whatsapp}</p>
                                <p class="text-sm text-gray-500">${notification.tipo}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-sm font-medium text-gray-900">${statusText[notification.status]}</span>
                            <p class="text-xs text-gray-500">${new Date(notification.created_at).toLocaleString('pt-BR')}</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <p class="text-sm text-gray-700">${notification.mensagem}</p>
                    </div>
                    
                    ${notification.erro_detalhes ? `
                        <div class="bg-red-50 border border-red-200 rounded p-3">
                            <p class="text-sm text-red-700">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                ${notification.erro_detalhes}
                            </p>
                        </div>
                    ` : ''}
                    
                    ${notification.data_envio ? `
                        <div class="text-xs text-gray-500 mt-2">
                            Enviado em: ${new Date(notification.data_envio).toLocaleString('pt-BR')}
                        </div>
                    ` : ''}
                `;
                container.appendChild(div);
            });
        }

        // Load logs
        async function loadLogs() {
            const loadingDiv = document.getElementById('loadingLogs');
            const listDiv = document.getElementById('logsList');

            loadingDiv.classList.remove('hidden');
            listDiv.classList.add('hidden');

            try {
                let query = supabase
                    .from('admin_logs')
                    .select(`
                        *,
                        users (name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(100);

                // Apply filter
                const acaoFilter = document.getElementById('acaoFilter')?.value;
                if (acaoFilter) {
                    query = query.ilike('acao', `%${acaoFilter}%`);
                }

                const { data: logs, error } = await query;

                if (error) throw error;

                renderLogs(logs || []);
                listDiv.classList.remove('hidden');

            } catch (error) {
                console.error('Erro ao carregar logs:', error);
                showToast('Erro ao carregar logs', 'error');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        // Render logs
        function renderLogs(logs) {
            const container = document.getElementById('logsList');
            container.innerHTML = '';

            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-history text-4xl text-gray-400 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Nenhum log encontrado</h3>
                        <p class="text-gray-600">Logs de atividades aparecerão aqui.</p>
                    </div>
                `;
                return;
            }

            logs.forEach(log => {
                const div = document.createElement('div');
                div.className = 'bg-white border border-gray-200 rounded-lg p-4';
                
                div.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-${getLogIcon(log.acao)} text-gray-600"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900">${log.acao}</h4>
                                <p class="text-sm text-gray-600">${log.detalhes}</p>
                                <p class="text-sm text-gray-500">
                                    ${log.tabela_afetada ? `Tabela: ${log.tabela_afetada}` : ''}
                                    ${log.users?.name ? ` - Por: ${log.users.name}` : ''}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-xs text-gray-500">${new Date(log.created_at).toLocaleString('pt-BR')}</p>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Get log icon
        function getLogIcon(acao) {
            const icons = {
                'criar': 'plus',
                'editar': 'edit',
                'pausar': 'pause',
                'remover': 'trash',
                'reativar': 'play'
            };
            return icons[acao.toLowerCase()] || 'cog';
        }

        // Modal functions
        function openEscolaModal(escolaId = null) {
            currentEscola = escolaId;
            
            if (escolaId) {
                document.getElementById('escolaModalTitle').innerHTML = '<i class="fas fa-school mr-2 text-red-600"></i>Editar Escola';
                loadEscolaData(escolaId);
            } else {
                document.getElementById('escolaModalTitle').innerHTML = '<i class="fas fa-school mr-2 text-red-600"></i>Nova Escola';
                document.getElementById('escolaForm').reset();
                
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const nextYear = new Date();
                nextYear.setFullYear(nextYear.getFullYear() + 1);
                
                document.getElementById('dataContrato').value = today;
                document.getElementById('dataVencimentoEscola').value = nextYear.toISOString().split('T')[0];
            }
            
            document.getElementById('escolaModal').classList.remove('hidden');
        }

        function closeEscolaModal() {
            document.getElementById('escolaModal').classList.add('hidden');
            currentEscola = null;
        }

        function openUsuarioModal(usuarioId = null) {
            currentUsuario = usuarioId;
            
            if (usuarioId) {
                document.getElementById('usuarioModalTitle').innerHTML = '<i class="fas fa-user-edit mr-2 text-blue-600"></i>Editar Usuário';
                loadUsuarioData(usuarioId);
            } else {
                document.getElementById('usuarioModalTitle').innerHTML = '<i class="fas fa-user-plus mr-2 text-blue-600"></i>Novo Usuário';
                document.getElementById('usuarioForm').reset();
                
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('dataMatricula').value = today;
            }
            
            document.getElementById('usuarioModal').classList.remove('hidden');
        }

        function closeUsuarioModal() {
            document.getElementById('usuarioModal').classList.add('hidden');
            currentUsuario = null;
        }

        function openWhatsAppModal(userId = null) {
            if (userId) {
                document.getElementById('destinatarioWhatsApp').value = userId;
            }
            
            // Load users with WhatsApp for select
            loadUsersForWhatsApp();
            
            document.getElementById('whatsappModal').classList.remove('hidden');
        }

        function closeWhatsAppModal() {
            document.getElementById('whatsappModal').classList.add('hidden');
            document.getElementById('whatsappForm').reset();
        }

        // Load escola data for editing
        async function loadEscolaData(escolaId) {
            try {
                const { data: escola, error } = await supabase
                    .from('schools')
                    .select('*')
                    .eq('id', escolaId)
                    .single();

                if (error) throw error;

                // Fill form
                document.getElementById('escolaId').value = escola.id;
                document.getElementById('nomeEscola').value = escola.name || '';
                document.getElementById('emailEscola').value = escola.email || '';
                document.getElementById('enderecoEscola').value = escola.endereco || '';
                document.getElementById('telefoneEscola').value = escola.telefone || '';
                document.getElementById('planoEscola').value = escola.plano || 'basico';
                document.getElementById('diretorNome').value = escola.diretor_nome || '';
                document.getElementById('diretorWhatsapp').value = escola.diretor_whatsapp || '';
                document.getElementById('dataContrato').value = escola.data_contrato || '';
                document.getElementById('dataVencimentoEscola').value = escola.data_vencimento_escola || '';
                document.getElementById('observacoesEscola').value = escola.observacoes_escola || '';

            } catch (error) {
                console.error('Erro ao carregar dados da escola:', error);
                showToast('Erro ao carregar dados da escola', 'error');
            }
        }

        // Load usuario data for editing
        async function loadUsuarioData(usuarioId) {
            try {
                const { data: usuario, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', usuarioId)
                    .single();

                if (error) throw error;

                // Fill form
                document.getElementById('usuarioId').value = usuario.id;
                document.getElementById('nomeUsuario').value = usuario.name || '';
                document.getElementById('emailUsuario').value = usuario.email || '';
                document.getElementById('whatsappUsuario').value = usuario.whatsapp || '';
                document.getElementById('tipoUsuario').value = usuario.user_type || '';
                document.getElementById('escolaUsuario').value = usuario.school_id || '';
                document.getElementById('statusUsuario').value = usuario.status_usuario || 'ativo';
                document.getElementById('dataMatricula').value = usuario.data_matricula || '';
                document.getElementById('dataVencimentoUsuario').value = usuario.data_vencimento || '';
                document.getElementById('observacoesUsuario').value = usuario.observacoes_admin || '';

            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
                showToast('Erro ao carregar dados do usuário', 'error');
            }
        }

        // Load users for WhatsApp select
        async function loadUsersForWhatsApp() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select(`
                        id, name, whatsapp, user_type,
                        schools (name)
                    `)
                    .not('whatsapp', 'is', null)
                    .neq('user_type', 'admin')
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('destinatarioWhatsApp');
                select.innerHTML = '<option value="">Selecione o destinatário</option>';

                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.whatsapp}) - ${user.schools?.name}`;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Erro ao carregar usuários para WhatsApp:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Filter changes
            document.getElementById('escolaFilterUsuarios')?.addEventListener('change', loadUsuarios);
            document.getElementById('tipoFilterUsuarios')?.addEventListener('change', loadUsuarios);
            document.getElementById('prioridadeFilter')?.addEventListener('change', loadRecados);
            document.getElementById('tipoSolicitacaoFilter')?.addEventListener('change', loadRecados);
            document.getElementById('acaoFilter')?.addEventListener('change', loadLogs);

            // Escola form
            document.getElementById('escolaForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveEscola();
            });

            // Usuario form
            document.getElementById('usuarioForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveUsuario();
            });

            // WhatsApp form
            document.getElementById('whatsappForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await sendWhatsAppMessage();
            });

            // WhatsApp message type change
            document.getElementById('tipoMensagem')?.addEventListener('change', function() {
                const tipo = this.value;
                const mensagemField = document.getElementById('mensagemWhatsApp');
                
                const templates = {
                    'vencimento': 'Olá! Seu plano no Sistema Semanário vence em breve. Entre em contato para renovar e continuar aproveitando todos os benefícios.',
                    'renovacao': 'Seu plano no Sistema Semanário venceu. Renove agora para continuar usando todas as funcionalidades. Entre em contato conosco!',
                    'boas-vindas': 'Bem-vindo(a) ao Sistema Semanário! Estamos felizes em tê-lo(a) conosco. Em caso de dúvidas, estamos aqui para ajudar.',
                    'suporte': 'Olá! Recebemos sua solicitação de suporte. Nossa equipe está analisando e retornará em breve. Obrigado pela paciência!'
                };

                if (templates[tipo]) {
                    mensagemField.value = templates[tipo];
                } else if (tipo === 'personalizada') {
                    mensagemField.value = '';
                }
            });

            // Close modals on outside click
            ['escolaModal', 'usuarioModal', 'whatsappModal'].forEach(modalId => {
                document.getElementById(modalId).addEventListener('click', function(e) {
                    if (e.target.id === modalId) {
                        if (modalId === 'escolaModal') closeEscolaModal();
                        else if (modalId === 'usuarioModal') closeUsuarioModal();
                        else if (modalId === 'whatsappModal') closeWhatsAppModal();
                    }
                });
            });

            // Close notifications when clicking outside
            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('notificationsDropdown');
                const button = document.getElementById('notificationBtn');
                
                if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });
        }

        // Save escola
        async function saveEscola() {
            const form = document.getElementById('escolaForm');
            const formData = new FormData(form);
            
            const saveBtn = document.getElementById('salvarEscolaBtn');
            const saveText = document.getElementById('salvarEscolaText');
            const saveLoading = document.getElementById('salvarEscolaLoading');
            
            saveText.classList.add('hidden');
            saveLoading.classList.remove('hidden');
            saveBtn.disabled = true;

            try {
                const escolaData = {
                    name: formData.get('nomeEscola'),
                    email: formData.get('emailEscola'),
                    endereco: formData.get('enderecoEscola'),
                    telefone: formData.get('telefoneEscola'),
                    plano: formData.get('planoEscola'),
                    diretor_nome: formData.get('diretorNome'),
                    diretor_whatsapp: formData.get('diretorWhatsapp'),
                    data_contrato: formData.get('dataContrato'),
                    data_vencimento_escola: formData.get('dataVencimentoEscola'),
                    observacoes_escola: formData.get('observacoesEscola'),
                    status_escola: 'ativa'
                };

                let result;
                if (currentEscola) {
                    // Update
                    result = await supabase
                        .from('schools')
                        .update(escolaData)
                        .eq('id', currentEscola);
                    
                    await logAdminAction('editar', `Escola editada: ${escolaData.name}`, 'schools', currentEscola);
                } else {
                    // Insert
                    result = await supabase
                        .from('schools')
                        .insert([escolaData]);
                    
                    await logAdminAction('criar', `Nova escola criada: ${escolaData.name}`, 'schools');
                }

                if (result.error) throw result.error;

                showToast(currentEscola ? 'Escola atualizada com sucesso!' : 'Escola criada com sucesso!', 'success');
                closeEscolaModal();
                await loadEscolas();
                await loadEscolasForSelect();
                await loadStats();

            } catch (error) {
                console.error('Erro ao salvar escola:', error);
                showToast('Erro ao salvar escola: ' + error.message, 'error');
            } finally {
                saveText.classList.remove('hidden');
                saveLoading.classList.add('hidden');
                saveBtn.disabled = false;
            }
        }

        // Save usuario
        async function saveUsuario() {
            const form = document.getElementById('usuarioForm');
            const formData = new FormData(form);
            
            const saveBtn = document.getElementById('salvarUsuarioBtn');
            const saveText = document.getElementById('salvarUsuarioText');
            const saveLoading = document.getElementById('salvarUsuarioLoading');
            
            saveText.classList.add('hidden');
            saveLoading.classList.remove('hidden');
            saveBtn.disabled = true;

            try {
                const usuarioData = {
                    name: formData.get('nomeUsuario'),
                    email: formData.get('emailUsuario'),
                    whatsapp: formData.get('whatsappUsuario'),
                    user_type: formData.get('tipoUsuario'),
                    school_id: formData.get('escolaUsuario'),
                    status_usuario: formData.get('statusUsuario'),
                    data_matricula: formData.get('dataMatricula'),
                    data_vencimento: formData.get('dataVencimentoUsuario'),
                    observacoes_admin: formData.get('observacoesUsuario')
                };

                let result;
                if (currentUsuario) {
                    // Update
                    result = await supabase
                        .from('users')
                        .update(usuarioData)
                        .eq('id', currentUsuario);
                    
                    await logAdminAction('editar', `Usuário editado: ${usuarioData.name}`, 'users', currentUsuario);
                } else {
                    // Insert
                    result = await supabase
                        .from('users')
                        .insert([usuarioData]);
                    
                    await logAdminAction('criar', `Novo usuário criado: ${usuarioData.name}`, 'users');
                }

                if (result.error) throw result.error;

                showToast(currentUsuario ? 'Usuário atualizado com sucesso!' : 'Usuário criado com sucesso!', 'success');
                closeUsuarioModal();
                await loadUsuarios();
                await loadStats();

            } catch (error) {
                console.error('Erro ao salvar usuário:', error);
                showToast('Erro ao salvar usuário: ' + error.message, 'error');
            } finally {
                saveText.classList.remove('hidden');
                saveLoading.classList.add('hidden');
                saveBtn.disabled = false;
            }
        }

        // Send WhatsApp message
        async function sendWhatsAppMessage() {
            const form = document.getElementById('whatsappForm');
            const formData = new FormData(form);
            
            const sendBtn = document.getElementById('enviarWhatsAppBtn');
            const sendText = document.getElementById('enviarWhatsAppText');
            const sendLoading = document.getElementById('enviarWhatsAppLoading');
            
            sendText.classList.add('hidden');
            sendLoading.classList.remove('hidden');
            sendBtn.disabled = true;

            try {
                const destinatarioId = formData.get('destinatarioWhatsApp');
                const mensagem = formData.get('mensagemWhatsApp');
                const tipo = formData.get('tipoMensagem');

                // Get user data
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('whatsapp')
                    .eq('id', destinatarioId)
                    .single();

                if (userError) throw userError;

                // Save notification
                const { error: notificationError } = await supabase
                    .from('whatsapp_notifications')
                    .insert([{
                        destinatario_id: destinatarioId,
                        numero_whatsapp: user.whatsapp,
                        mensagem: mensagem,
                        tipo: tipo,
                        status: 'enviado', // In production, this would be 'pendente' until actually sent
                        data_envio: new Date().toISOString()
                    }]);

                if (notificationError) throw notificationError;

                await logAdminAction('enviar_whatsapp', `WhatsApp enviado para ${user.whatsapp}`, 'whatsapp_notifications');

                showToast('Mensagem WhatsApp enviada com sucesso!', 'success');
                closeWhatsAppModal();
                await loadWhatsApp();

            } catch (error) {
                console.error('Erro ao enviar WhatsApp:', error);
                showToast('Erro ao enviar WhatsApp: ' + error.message, 'error');
            } finally {
                sendText.classList.remove('hidden');
                sendLoading.classList.add('hidden');
                sendBtn.disabled = false;
            }
        }

        // Log admin action
        async function logAdminAction(acao, detalhes, tabela = null, registroId = null) {
            try {
                await supabase
                    .from('admin_logs')
                    .insert([{
                        admin_id: currentUser?.id,
                        acao: acao,
                        detalhes: detalhes,
                        tabela_afetada: tabela,
                        registro_id: registroId
                    }]);
            } catch (error) {
                console.error('Erro ao registrar log:', error);
            }
        }

        // Edit functions
        async function editEscola(escolaId) {
            openEscolaModal(escolaId);
        }

        async function editUsuario(usuarioId) {
            openUsuarioModal(usuarioId);
        }

        // Status change functions
        async function pausarEscola(escolaId) {
            if (!confirm('Tem certeza que deseja pausar esta escola?')) return;

            try {
                const { error } = await supabase
                    .from('schools')
                    .update({ status_escola: 'pausada' })
                    .eq('id', escolaId);

                if (error) throw error;

                await logAdminAction('pausar', 'Escola pausada', 'schools', escolaId);
                showToast('Escola pausada com sucesso!', 'success');
                await loadEscolas();
                await loadStats();

            } catch (error) {
                console.error('Erro ao pausar escola:', error);
                showToast('Erro ao pausar escola', 'error');
            }
        }

        async function reativarEscola(escolaId) {
            if (!confirm('Tem certeza que deseja reativar esta escola?')) return;

            try {
                const { error } = await supabase
                    .from('schools')
                    .update({ status_escola: 'ativa' })
                    .eq('id', escolaId);

                if (error) throw error;

                await logAdminAction('reativar', 'Escola reativada', 'schools', escolaId);
                showToast('Escola reativada com sucesso!', 'success');
                await loadEscolas();
                await loadStats();

            } catch (error) {
                console.error('Erro ao reativar escola:', error);
                showToast('Erro ao reativar escola', 'error');
            }
        }

        async function removerEscola(escolaId) {
            if (!confirm('Tem certeza que deseja remover esta escola? Esta ação não pode ser desfeita.')) return;

            try {
                const { error } = await supabase
                    .from('schools')
                    .update({ status_escola: 'removida' })
                    .eq('id', escolaId);

                if (error) throw error;

                await logAdminAction('remover', 'Escola removida', 'schools', escolaId);
                showToast('Escola removida com sucesso!', 'success');
                await loadEscolas();
                await loadStats();

            } catch (error) {
                console.error('Erro ao remover escola:', error);
                showToast('Erro ao remover escola', 'error');
            }
        }

        async function pausarUsuario(usuarioId) {
            if (!confirm('Tem certeza que deseja pausar este usuário?')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status_usuario: 'pausado' })
                    .eq('id', usuarioId);

                if (error) throw error;

                await logAdminAction('pausar', 'Usuário pausado', 'users', usuarioId);
                showToast('Usuário pausado com sucesso!', 'success');
                await loadUsuarios();
                await loadStats();

            } catch (error) {
                console.error('Erro ao pausar usuário:', error);
                showToast('Erro ao pausar usuário', 'error');
            }
        }

        async function reativarUsuario(usuarioId) {
            if (!confirm('Tem certeza que deseja reativar este usuário?')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status_usuario: 'ativo' })
                    .eq('id', usuarioId);

                if (error) throw error;

                await logAdminAction('reativar', 'Usuário reativado', 'users', usuarioId);
                showToast('Usuário reativado com sucesso!', 'success');
                await loadUsuarios();
                await loadStats();

            } catch (error) {
                console.error('Erro ao reativar usuário:', error);
                showToast('Erro ao reativar usuário', 'error');
            }
        }

        async function removerUsuario(usuarioId) {
            if (!confirm('Tem certeza que deseja remover este usuário? Esta ação não pode ser desfeita.')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({ status_usuario: 'removido' })
                    .eq('id', usuarioId);

                if (error) throw error;

                await logAdminAction('remover', 'Usuário removido', 'users', usuarioId);
                showToast('Usuário removido com sucesso!', 'success');
                await loadUsuarios();
                await loadStats();

            } catch (error) {
                console.error('Erro ao remover usuário:', error);
                showToast('Erro ao remover usuário', 'error');
            }
        }

        // WhatsApp functions
        async function sendWhatsAppToUser(usuarioId) {
            openWhatsAppModal(usuarioId);
        }

        async function sendRenewalWhatsApp(tipo, id) {
            try {
                let user, mensagem;
                
                if (tipo === 'escola') {
                    const { data: escola, error } = await supabase
                        .from('schools')
                        .select('diretor_nome, diretor_whatsapp, name, data_vencimento_escola')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    mensagem = `Olá ${escola.diretor_nome}! O plano da ${escola.name} no Sistema Semanário vence em ${new Date(escola.data_vencimento_escola).toLocaleDateString('pt-BR')}. Entre em contato para renovar: (11) 99999-9999`;
                    
                    await supabase
                        .from('whatsapp_notifications')
                        .insert([{
                            destinatario_id: null,
                            numero_whatsapp: escola.diretor_whatsapp,
                            mensagem: mensagem,
                            tipo: 'renovacao',
                            status: 'enviado',
                            data_envio: new Date().toISOString()
                        }]);

                } else {
                    const { data: usuario, error } = await supabase
                        .from('users')
                        .select('name, whatsapp, data_vencimento, id')
                        .eq('id', id)
                        .single();

                    if (error) throw error;

                    mensagem = `Olá ${usuario.name}! Seu plano no Sistema Semanário venceu em ${new Date(usuario.data_vencimento).toLocaleDateString('pt-BR')}. Renove agora para continuar usando: (11) 99999-9999`;
                    
                    await supabase
                        .from('whatsapp_notifications')
                        .insert([{
                            destinatario_id: usuario.id,
                            numero_whatsapp: usuario.whatsapp,
                            mensagem: mensagem,
                            tipo: 'renovacao',
                            status: 'enviado',
                            data_envio: new Date().toISOString()
                        }]);
                }

                await logAdminAction('enviar_whatsapp', `Notificação de renovação enviada`, 'whatsapp_notifications');
                showToast('Notificação de renovação enviada!', 'success');

            } catch (error) {
                console.error('Erro ao enviar notificação:', error);
                showToast('Erro ao enviar notificação', 'error');
            }
        }

        async function replyWhatsApp(userId) {
            openWhatsAppModal(userId);
        }

        async function sendWhatsAppNotifications() {
            if (!confirm('Deseja enviar notificações automáticas para todos os vencimentos próximos?')) return;

            try {
                // Get users expiring in 7 days
                const sevenDaysFromNow = new Date();
                sevenDaysFromNow.setDate(sevenDaysFromNow.getDate() + 7);
                
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, name, whatsapp, data_vencimento')
                    .lte('data_vencimento', sevenDaysFromNow.toISOString().split('T')[0])
                    .gte('data_vencimento', new Date().toISOString().split('T')[0])
                    .eq('status_usuario', 'ativo')
                    .not('whatsapp', 'is', null);

                if (error) throw error;

                let sent = 0;
                for (const user of users) {
                    const diasRestantes = Math.ceil((new Date(user.data_vencimento) - new Date()) / (1000 * 60 * 60 * 24));
                    const mensagem = `Olá ${user.name}! Seu plano no Sistema Semanário vence em ${diasRestantes} dias (${new Date(user.data_vencimento).toLocaleDateString('pt-BR')}). Renove para continuar usando: (11) 99999-9999`;
                    
                    await supabase
                        .from('whatsapp_notifications')
                        .insert([{
                            destinatario_id: user.id,
                            numero_whatsapp: user.whatsapp,
                            mensagem: mensagem,
                            tipo: 'vencimento',
                            status: 'enviado',
                            data_envio: new Date().toISOString()
                        }]);
                    
                    sent++;
                }

                await logAdminAction('enviar_whatsapp_lote', `${sent} notificações automáticas enviadas`, 'whatsapp_notifications');
                showToast(`${sent} notificações enviadas com sucesso!`, 'success');
                await loadWhatsApp();

            } catch (error) {
                console.error('Erro ao enviar notificações:', error);
                showToast('Erro ao enviar notificações', 'error');
            }
        }

        // Check vencimentos
        async function checkVencimentos() {
            showToast('Verificando vencimentos...', 'info');
            await loadVencimentos();
            await loadStats();
            showToast('Vencimentos atualizados!', 'success');
        }

        // Mark as read
        async function markAsRead(recadoId) {
            try {
                const { error } = await supabase
                    .from('recados')
                    .update({ lido: true })
                    .eq('id', recadoId);

                if (error) throw error;

                await loadRecados();
                await loadNotifications();
                showToast('Recado marcado como lido', 'success');

            } catch (error) {
                console.error('Erro ao marcar como lido:', error);
                showToast('Erro ao marcar como lido', 'error');
            }
        }

        // Toggle notifications
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Access functions
        function accessProfessor() {
            window.open('professor.html', '_blank');
        }

        function accessCoordenador() {
            window.open('coordenador.html', '_blank');
        }

        function accessDiretor() {
            window.open('diretor.html', '_blank');
        }

        // Logout
        function logout() {
            if (confirm('Tem certeza que deseja sair?')) {
                window.location.href = 'index.html';
            }
        }

        // Show toast
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');

            const icons = {
                'success': '<i class="fas fa-check-circle text-green-500 text-xl"></i>',
                'error': '<i class="fas fa-times-circle text-red-500 text-xl"></i>',
                'warning': '<i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>',
                'info': '<i class="fas fa-info-circle text-blue-500 text-xl"></i>'
            };

            icon.innerHTML = icons[type] || icons.info;
            messageEl.textContent = message;

            toast.classList.remove('translate-x-full');
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 4000);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9811c9ff022536f4',t:'MTc1ODIwODQyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
