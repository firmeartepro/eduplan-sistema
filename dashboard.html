// DEBUG: Verificar se Firebase está carregado
console.log('=== DEBUG DATABASE.JS ===');
console.log('Firebase disponível:', typeof firebase);
console.log('Auth disponível:', typeof auth);
console.log('DB disponível:', typeof db);

// Funções do Banco de Dados

// Salvar planejamento de aula
async function saveLessonPlan(planData) {
    console.log('=== DEBUG SAVE LESSON PLAN ===');
    console.log('Dados recebidos:', planData);
    
    try {
        // Verificar se Firebase está inicializado
        if (typeof firebase === 'undefined') {
            throw new Error('Firebase não está carregado');
        }
        
        if (typeof auth === 'undefined') {
            throw new Error('Auth não está inicializado');
        }
        
        if (typeof db === 'undefined') {
            throw new Error('Firestore não está inicializado');
        }
        
        const user = auth.currentUser;
        console.log('Usuário atual:', user);
        
        if (!user) {
            throw new Error('Usuário não autenticado');
        }
        
        // Validar dados obrigatórios
        if (!planData.subject || !planData.class || !planData.date) {
            throw new Error('Disciplina, turma e data são obrigatórios');
        }
        
        console.log('Tentando salvar no Firestore...');
        
        const docData = {
            ...planData,
            userId: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            week: getWeekString(new Date(planData.date)),
            year: new Date(planData.date).getFullYear()
        };
        
        console.log('Dados para salvar:', docData);
        
        const docRef = await db.collection('lessonPlans').add(docData);
        
        console.log('Planejamento salvo com sucesso! ID:', docRef.id);
        return docRef.id;
        
    } catch (error) {
        console.error('=== ERRO DETALHADO ===');
        console.error('Tipo do erro:', error.constructor.name);
        console.error('Mensagem:', error.message);
        console.error('Stack:', error.stack);
        console.error('Código do erro:', error.code);
        throw error;
    }
}

// Buscar planejamentos do usuário
async function getUserLessonPlans() {
    console.log('=== DEBUG GET USER LESSON PLANS ===');
    
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('Usuário não autenticado');
        
        console.log('Buscando planejamentos para usuário:', user.uid);
        
        const snapshot = await db.collection('lessonPlans')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        const plans = [];
        snapshot.forEach(doc => {
            plans.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        console.log('Planejamentos encontrados:', plans.length);
        return plans;
        
    } catch (error) {
        console.error('Erro ao buscar planejamentos:', error);
        throw error;
    }
}

// Buscar planejamento por ID
async function getLessonPlanById(planId) {
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('Usuário não autenticado');
        
        const doc = await db.collection('lessonPlans').doc(planId).get();
        
        if (doc.exists && doc.data().userId === user.uid) {
            return {
                id: doc.id,
                ...doc.data()
            };
        } else {
            throw new Error('Planejamento não encontrado');
        }
        
    } catch (error) {
        console.error('Erro ao buscar planejamento:', error);
        throw error;
    }
}

// Atualizar planejamento
async function updateLessonPlan(planId, planData) {
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('Usuário não autenticado');
        
        await db.collection('lessonPlans').doc(planId).update({
            ...planData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('Planejamento atualizado:', planId);
        return planId;
        
    } catch (error) {
        console.error('Erro ao atualizar planejamento:', error);
        throw error;
    }
}

// Deletar planejamento
async function deleteLessonPlan(planId) {
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('Usuário não autenticado');
        
        // Verificar se o planejamento pertence ao usuário
        const doc = await db.collection('lessonPlans').doc(planId).get();
        
        if (!doc.exists || doc.data().userId !== user.uid) {
            throw new Error('Planejamento não encontrado ou sem permissão');
        }
        
        await db.collection('lessonPlans').doc(planId).delete();
        console.log('Planejamento deletado:', planId);
        
    } catch (error) {
        console.error('Erro ao deletar planejamento:', error);
        throw error;
    }
}

// Salvar atividade
async function saveActivity(activityData) {
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('Usuário não autenticado');
        
        // Validar dados obrigatórios
        if (!activityData.title || !activityData.subject || !activityData.grade) {
            throw new Error('Título, disciplina e série são obrigatórios');
        }
        
        const docRef = await db.collection('activities').add({
            ...activityData,
            userId: user.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            isPublic: false,
            tags: generateTags(activityData)
        });
        
        console.log('Atividade salva com ID:', docRef.id);
        return docRef.id;
        
    } catch (error) {
        console.error('Erro ao salvar atividade:', error);
        throw error;
    }
}

// Buscar atividades do usuário
async function getUserActivities() {
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('Usuário não autenticado');
        
        const snapshot = await db.collection('activities')
            .where('userId', '==', user.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        const activities = [];
        snapshot.forEach(doc => {
            activities.push({
                id: doc.id,
                ...doc.data()
            });
        });
        
        return activities;
        
    } catch (error) {
        console.error('Erro ao buscar atividades:', error);
        throw error;
    }
}

// Buscar dados do usuário
async function getUserData() {
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('Usuário não autenticado');
        
        const doc = await db.collection('users').doc(user.uid).get();
        
        if (doc.exists) {
            return doc.data();
        } else {
            // Se não existe, criar dados básicos
            const userData = {
                name: user.displayName || 'Professor',
                email: user.email,
                subscription: {
                    plan: 'trial',
                    status: 'active'
                }
            };
            
            await db.collection('users').doc(user.uid).set(userData);
            return userData;
        }
        
    } catch (error) {
        console.error('Erro ao buscar dados do usuário:', error);
        throw error;
    }
}

// Atualizar dados do usuário
async function updateUserData(userData) {
    try {
        const user = auth.currentUser;
        if (!user) throw new Error('Usuário não autenticado');
        
        await db.collection('users').doc(user.uid).update({
            ...userData,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('Dados do usuário atualizados');
        
    } catch (error) {
        console.error('Erro ao atualizar dados do usuário:', error);
        throw error;
    }
}

// Funções utilitárias

// Gerar string da semana (formato: 2024-W10)
function getWeekString(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNum = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return `${d.getUTCFullYear()}-W${weekNum.toString().padStart(2, '0')}`;
}

// Gerar tags automaticamente para atividades
function generateTags(activityData) {
    const tags = [];
    
    if (activityData.subject) tags.push(activityData.subject);
    if (activityData.grade) tags.push(`${activityData.grade}ano`);
    if (activityData.type) tags.push(activityData.type);
    
    return tags;
}

// Verificar se todas as funções foram carregadas
console.log('=== FUNÇÕES CARREGADAS ===');
console.log('saveLessonPlan:', typeof saveLessonPlan);
console.log('getUserLessonPlans:', typeof getUserLessonPlans);
console.log('saveActivity:', typeof saveActivity);
console.log('getUserActivities:', typeof getUserActivities);
console.log('getUserData:', typeof getUserData);

console.log('Funções do banco de dados carregadas com debug!');
