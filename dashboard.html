<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPlan - Dashboard Professor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .status-draft { background: #FEF3C7; color: #92400E; }
        .status-submitted { background: #DBEAFE; color: #1E40AF; }
        .status-approved { background: #D1FAE5; color: #065F46; }
        .status-rejected { background: #FEE2E2; color: #991B1B; }
        .sidebar-active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg transform -translate-x-full lg:translate-x-0 transition-transform duration-300 z-50">
        <div class="p-6 border-b">
            <div class="flex items-center">
                <div class="w-10 h-10 gradient-bg rounded-lg flex items-center justify-center mr-3">
                    <i class="fas fa-graduation-cap text-white"></i>
                </div>
                <div>
                    <h2 class="font-bold text-gray-800">EduPlan</h2>
                    <p class="text-sm text-gray-600">Professor</p>
                </div>
            </div>
        </div>
        
        <nav class="p-4">
            <ul class="space-y-2">
                <li>
                    <a href="#" onclick="showSection('dashboard')" class="sidebar-item sidebar-active flex items-center p-3 rounded-lg transition-colors">
                        <i class="fas fa-home mr-3"></i>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('plans')" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-book mr-3"></i>
                        Planos de Aula
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('calendar')" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-calendar mr-3"></i>
                        Calendário
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('feedbacks')" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-comments mr-3"></i>
                        Devolutivas
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showSection('profile')" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-gray-100 transition-colors">
                        <i class="fas fa-user mr-3"></i>
                        Perfil
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="absolute bottom-4 left-4 right-4">
            <button onclick="logout()" class="w-full flex items-center justify-center p-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                <i class="fas fa-sign-out-alt mr-2"></i>
                Sair
            </button>
        </div>
    </div>

    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-white rounded-lg shadow-lg">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <div class="lg:ml-64 min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b p-4 lg:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800" id="pageTitle">Dashboard</h1>
                    <p class="text-gray-600" id="pageSubtitle">Bem-vindo de volta!</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <button class="p-2 text-gray-600 hover:text-gray-800 relative">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">0</span>
                        </button>
                    </div>
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center mr-2">
                            <i class="fas fa-user text-white text-sm"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-700" id="userName">Carregando...</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="section-content p-4 lg:p-6">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-book text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Total de Planos</p>
                            <p class="text-2xl font-bold text-gray-800" id="totalPlans">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Aprovados</p>
                            <p class="text-2xl font-bold text-gray-800" id="approvedPlans">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Pendentes</p>
                            <p class="text-2xl font-bold text-gray-800" id="pendingPlans">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-comments text-purple-600 text-xl"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Devolutivas</p>
                            <p class="text-2xl font-bold text-gray-800" id="totalFeedbacks">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Status dos Planos</h3>
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Planos por Mês</h3>
                    <canvas id="monthlyChart" width="400" height="200"></canvas>
                </div>
            </div>

            <!-- Recent Plans -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-800">Planos Recentes</h3>
                    <button onclick="showSection('plans')" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        Ver todos
                    </button>
                </div>
                <div id="recentPlans" class="space-y-4">
                    <!-- Plans will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Plans Section -->
        <div id="plansSection" class="section-content hidden p-4 lg:p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Planos de Aula</h2>
                    <p class="text-gray-600">Gerencie seus planos de aula</p>
                </div>
                <button onclick="showCreatePlanModal()" class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-all">
                    <i class="fas fa-plus mr-2"></i>
                    Novo Plano
                </button>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="filterStatus" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Todos</option>
                            <option value="draft">Rascunho</option>
                            <option value="submitted">Enviado</option>
                            <option value="approved">Aprovado</option>
                            <option value="rejected">Rejeitado</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Matéria</label>
                        <select id="filterSubject" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data</label>
                        <input type="date" id="filterDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="applyFilters()" class="w-full bg-gray-800 text-white px-4 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                            <i class="fas fa-search mr-2"></i>
                            Filtrar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Plans List -->
            <div id="plansList" class="space-y-4">
                <!-- Plans will be loaded here -->
            </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendarSection" class="section-content hidden p-4 lg:p-6">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-6">Calendário de Aulas</h3>
                <div id="calendar" class="grid grid-cols-7 gap-2">
                    <!-- Calendar will be generated here -->
                </div>
            </div>
        </div>

        <!-- Feedbacks Section -->
        <div id="feedbacksSection" class="section-content hidden p-4 lg:p-6">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-6">Devolutivas Recebidas</h3>
                <div id="feedbacksList" class="space-y-4">
                    <!-- Feedbacks will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profileSection" class="section-content hidden p-4 lg:p-6">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-6">Meu Perfil</h3>
                <form id="profileForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                            <input type="text" id="profileName" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="profileEmail" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefone</label>
                            <input type="tel" id="profilePhone" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Matéria Principal</label>
                            <input type="text" id="profileSubject" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-all">
                        <i class="fas fa-save mr-2"></i>
                        Salvar Alterações
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Plan Modal -->
    <div id="createPlanModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-gray-800">Novo Plano de Aula</h3>
                    <button onclick="hideCreatePlanModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <form id="createPlanForm" class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Título *</label>
                        <input type="text" id="planTitle" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Matéria *</label>
                        <input type="text" id="planSubject" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data *</label>
                        <input type="date" id="planDate" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Duração (minutos) *</label>
                        <input type="number" id="planDuration" required min="1" value="50" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Objetivos *</label>
                    <textarea id="planObjectives" required rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Descreva os objetivos da aula..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Conteúdo *</label>
                    <textarea id="planContent" required rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Descreva o conteúdo que será abordado..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Metodologia *</label>
                    <textarea id="planMethodology" required rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Descreva a metodologia utilizada..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Recursos</label>
                    <textarea id="planResources" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Liste os recursos necessários..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Avaliação</label>
                    <textarea id="planEvaluation" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Como será avaliado o aprendizado..."></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                    <textarea id="planObservations" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Observações adicionais..."></textarea>
                </div>
                
                <div class="flex items-center justify-end space-x-4 pt-6 border-t">
                    <button type="button" onclick="hideCreatePlanModal()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="gradient-bg text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition-all">
                        <i class="fas fa-save mr-2"></i>
                        Salvar Plano
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://srqqheacsglhyyhvfchg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNycXFoZWFjc2dsaHl5aHZmY2hnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNTMxMDMsImV4cCI6MjA3MzcyOTEwM30.ZOKVDK1FEyDM-lcPrw4-0xbVDxYLftek3NHYcmjc_7w';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let currentSection = 'dashboard';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            setupEventListeners();
            await loadDashboardData();
        });

        // Check authentication
        async function checkAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = './index.html';
                    return;
                }

                const { data: userProfile } = await supabase
                    .from('users')
                    .select('*, schools(name)')
                    .eq('email', session.user.email)
                    .single();

                if (!userProfile || userProfile.user_type !== 'professor') {
                    alert('Acesso negado. Esta área é apenas para professores.');
                    window.location.href = './index.html';
                    return;
                }

                currentUser = userProfile;
                document.getElementById('userName').textContent = userProfile.name;
            } catch (error) {
                console.error('Erro na autenticação:', error);
                window.location.href = './index.html';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Mobile menu
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('-translate-x-full');
            });

            // Create plan form
            document.getElementById('createPlanForm').addEventListener('submit', handleCreatePlan);
            
            // Profile form
            document.getElementById('profileForm').addEventListener('submit', handleUpdateProfile);

            // Set today's date as default
            document.getElementById('planDate').valueAsDate = new Date();
        }

        // Show section
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(el => {
                el.classList.add('hidden');
            });

            // Remove active class from all sidebar items
            document.querySelectorAll('.sidebar-item').forEach(el => {
                el.classList.remove('sidebar-active');
                el.classList.add('hover:bg-gray-100');
            });

            // Show selected section
            document.getElementById(section + 'Section').classList.remove('hidden');
            
            // Add active class to selected sidebar item
            event.target.classList.add('sidebar-active');
            event.target.classList.remove('hover:bg-gray-100');

            // Update page title
            const titles = {
                dashboard: { title: 'Dashboard', subtitle: 'Bem-vindo de volta!' },
                plans: { title: 'Planos de Aula', subtitle: 'Gerencie seus planos de aula' },
                calendar: { title: 'Calendário', subtitle: 'Visualize suas aulas' },
                feedbacks: { title: 'Devolutivas', subtitle: 'Feedback da coordenação' },
                profile: { title: 'Perfil', subtitle: 'Gerencie suas informações' }
            };

            document.getElementById('pageTitle').textContent = titles[section].title;
            document.getElementById('pageSubtitle').textContent = titles[section].subtitle;

            currentSection = section;

            // Load section data
            switch(section) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'plans':
                    loadPlans();
                    break;
                case 'calendar':
                    loadCalendar();
                    break;
                case 'feedbacks':
                    loadFeedbacks();
                    break;
                case 'profile':
                    loadProfile();
                    break;
            }

            // Close mobile menu
            document.getElementById('sidebar').classList.add('-translate-x-full');
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load lesson plans stats
                const { data: plans } = await supabase
                    .from('lesson_plans')
                    .select('*')
                    .eq('teacher_id', currentUser.id);

                const totalPlans = plans?.length || 0;
                const approvedPlans = plans?.filter(p => p.status === 'approved').length || 0;
                const pendingPlans = plans?.filter(p => p.status === 'submitted').length || 0;

                document.getElementById('totalPlans').textContent = totalPlans;
                document.getElementById('approvedPlans').textContent = approvedPlans;
                document.getElementById('pendingPlans').textContent = pendingPlans;

                // Load feedbacks count
                const { data: feedbacks } = await supabase
                    .from('feedbacks')
                    .select('*')
                    .in('lesson_plan_id', plans?.map(p => p.id) || []);

                document.getElementById('totalFeedbacks').textContent = feedbacks?.length || 0;

                // Load recent plans
                loadRecentPlans();

                // Load charts
                loadCharts(plans || []);

            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        // Load recent plans
        async function loadRecentPlans() {
            try {
                const { data: plans } = await supabase
                    .from('lesson_plans')
                    .select('*')
                    .eq('teacher_id', currentUser.id)
                    .order('created_at', { ascending: false })
                    .limit(5);

                const container = document.getElementById('recentPlans');
                
                if (!plans || plans.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum plano encontrado</p>';
                    return;
                }

                container.innerHTML = plans.map(plan => `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${plan.title}</h4>
                            <p class="text-sm text-gray-600">${plan.subject} • ${new Date(plan.date).toLocaleDateString('pt-BR')}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-medium status-${plan.status}">
                            ${getStatusText(plan.status)}
                        </span>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erro ao carregar planos recentes:', error);
            }
        }

        // Load charts
        function loadCharts(plans) {
            // Status Chart
            const statusCounts = {
                draft: plans.filter(p => p.status === 'draft').length,
                submitted: plans.filter(p => p.status === 'submitted').length,
                approved: plans.filter(p => p.status === 'approved').length,
                rejected: plans.filter(p => p.status === 'rejected').length
            };

            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Rascunho', 'Enviado', 'Aprovado', 'Rejeitado'],
                    datasets: [{
                        data: [statusCounts.draft, statusCounts.submitted, statusCounts.approved, statusCounts.rejected],
                        backgroundColor: ['#FCD34D', '#60A5FA', '#34D399', '#F87171']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Monthly Chart
            const monthlyData = {};
            plans.forEach(plan => {
                const month = new Date(plan.date).toLocaleDateString('pt-BR', { month: 'short' });
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });

            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(monthlyData),
                    datasets: [{
                        label: 'Planos',
                        data: Object.values(monthlyData),
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Load plans
        async function loadPlans() {
            try {
                const { data: plans } = await supabase
                    .from('lesson_plans')
                    .select('*')
                    .eq('teacher_id', currentUser.id)
                    .order('date', { ascending: false });

                const container = document.getElementById('plansList');
                
                if (!plans || plans.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum plano encontrado</p>';
                    return;
                }

                container.innerHTML = plans.map(plan => `
                    <div class="bg-white rounded-xl shadow-sm p-6 card-hover">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-800 mb-2">${plan.title}</h3>
                                <div class="flex items-center space-x-4 text-sm text-gray-600">
                                    <span><i class="fas fa-book mr-1"></i>${plan.subject}</span>
                                    <span><i class="fas fa-calendar mr-1"></i>${new Date(plan.date).toLocaleDateString('pt-BR')}</span>
                                    <span><i class="fas fa-clock mr-1"></i>${plan.duration} min</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-3 py-1 rounded-full text-xs font-medium status-${plan.status}">
                                    ${getStatusText(plan.status)}
                                </span>
                                <div class="relative">
                                    <button onclick="togglePlanMenu('${plan.id}')" class="p-2 text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div id="menu-${plan.id}" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border z-10">
                                        <a href="#" onclick="viewPlan('${plan.id}')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            <i class="fas fa-eye mr-2"></i>Visualizar
                                        </a>
                                        <a href="#" onclick="editPlan('${plan.id}')" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-50">
                                            <i class="fas fa-edit mr-2"></i>Editar
                                        </a>
                                        <a href="#" onclick="deletePlan('${plan.id}')" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50">
                                            <i class="fas fa-trash mr-2"></i>Excluir
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="text-gray-600 text-sm mb-4">${plan.objectives?.substring(0, 150)}${plan.objectives?.length > 150 ? '...' : ''}</p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>Criado em ${new Date(plan.created_at).toLocaleDateString('pt-BR')}</span>
                            <span>Atualizado em ${new Date(plan.updated_at).toLocaleDateString('pt-BR')}</span>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erro ao carregar planos:', error);
            }
        }

        // Load calendar
        function loadCalendar() {
            const calendar = document.getElementById('calendar');
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            // Generate calendar header
            const daysOfWeek = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            let calendarHTML = daysOfWeek.map(day => 
                `<div class="p-2 text-center font-semibold text-gray-600 bg-gray-100 rounded">${day}</div>`
            ).join('');
            
            // Generate calendar days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += '<div class="p-2 h-20 border border-gray-200 rounded"></div>';
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
                calendarHTML += `
                    <div class="p-2 h-20 border border-gray-200 rounded ${isToday ? 'bg-blue-100' : 'hover:bg-gray-50'}">
                        <div class="font-semibold text-sm ${isToday ? 'text-blue-600' : 'text-gray-800'}">${day}</div>
                        <div class="text-xs text-gray-600 mt-1">
                            <!-- Aulas do dia seriam carregadas aqui -->
                        </div>
                    </div>
                `;
            }
            
            calendar.innerHTML = calendarHTML;
        }

        // Load feedbacks
        async function loadFeedbacks() {
            try {
                const { data: feedbacks } = await supabase
                    .from('feedbacks')
                    .select(`
                        *,
                        lesson_plans(title, subject, date),
                        users(name)
                    `)
                    .in('lesson_plan_id', 
                        (await supabase
                            .from('lesson_plans')
                            .select('id')
                            .eq('teacher_id', currentUser.id)
                        ).data?.map(p => p.id) || []
                    )
                    .order('created_at', { ascending: false });

                const container = document.getElementById('feedbacksList');
                
                if (!feedbacks || feedbacks.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma devolutiva encontrada</p>';
                    return;
                }

                container.innerHTML = feedbacks.map(feedback => `
                    <div class="border border-gray-200 rounded-lg p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h4 class="font-semibold text-gray-800">${feedback.lesson_plans.title}</h4>
                                <p class="text-sm text-gray-600">${feedback.lesson_plans.subject} • ${new Date(feedback.lesson_plans.date).toLocaleDateString('pt-BR')}</p>
                            </div>
                            <div class="flex items-center">
                                ${Array.from({length: 5}, (_, i) => 
                                    `<i class="fas fa-star ${i < feedback.rating ? 'text-yellow-400' : 'text-gray-300'}"></i>`
                                ).join('')}
                            </div>
                        </div>
                        <p class="text-gray-700 mb-4">${feedback.feedback_text}</p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>Por: ${feedback.users.name}</span>
                            <span>${new Date(feedback.created_at).toLocaleDateString('pt-BR')}</span>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Erro ao carregar devolutivas:', error);
            }
        }

        // Load profile
        function loadProfile() {
            document.getElementById('profileName').value = currentUser.name || '';
            document.getElementById('profileEmail').value = currentUser.email || '';
            document.getElementById('profilePhone').value = currentUser.phone || '';
            document.getElementById('profileSubject').value = currentUser.subject || '';
        }

        // Handle create plan
        async function handleCreatePlan(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('planTitle').value,
                subject: document.getElementById('planSubject').value,
                date: document.getElementById('planDate').value,
                duration: parseInt(document.getElementById('planDuration').value),
                objectives: document.getElementById('planObjectives').value,
                content: document.getElementById('planContent').value,
                methodology: document.getElementById('planMethodology').value,
                resources: document.getElementById('planResources').value,
                evaluation: document.getElementById('planEvaluation').value,
                observations: document.getElementById('planObservations').value,
                teacher_id: currentUser.id,
                school_id: currentUser.school_id,
                status: 'draft'
            };

            try {
                const { error } = await supabase
                    .from('lesson_plans')
                    .insert([formData]);

                if (error) throw error;

                alert('Plano de aula criado com sucesso!');
                hideCreatePlanModal();
                document.getElementById('createPlanForm').reset();
                
                if (currentSection === 'plans') {
                    loadPlans();
                } else {
                    loadDashboardData();
                }

            } catch (error) {
                console.error('Erro ao criar plano:', error);
                alert('Erro ao criar plano de aula. Tente novamente.');
            }
        }

        // Handle update profile
        async function handleUpdateProfile(e) {
            e.preventDefault();
            
            const updateData = {
                name: document.getElementById('profileName').value,
                phone: document.getElementById('profilePhone').value,
                subject: document.getElementById('profileSubject').value
            };

            try {
                const { error } = await supabase
                    .from('users')
                    .update(updateData)
                    .eq('id', currentUser.id);

                if (error) throw error;

                alert('Perfil atualizado com sucesso!');
                currentUser = { ...currentUser, ...updateData };
                document.getElementById('userName').textContent = currentUser.name;

            } catch (error) {
                console.error('Erro ao atualizar perfil:', error);
                alert('Erro ao atualizar perfil. Tente novamente.');
            }
        }

        // Modal functions
        function showCreatePlanModal() {
            document.getElementById('createPlanModal').classList.remove('hidden');
            document.getElementById('createPlanModal').classList.add('flex');
        }

        function hideCreatePlanModal() {
            document.getElementById('createPlanModal').classList.add('hidden');
            document.getElementById('createPlanModal').classList.remove('flex');
        }

        // Utility functions
        function getStatusText(status) {
            const statusMap = {
                draft: 'Rascunho',
                submitted: 'Enviado',
                approved: 'Aprovado',
                rejected: 'Rejeitado'
            };
            return statusMap[status] || status;
        }

        function togglePlanMenu(planId) {
            const menu = document.getElementById(`menu-${planId}`);
            menu.classList.toggle('hidden');
            
            // Close other menus
            document.querySelectorAll('[id^="menu-"]').forEach(m => {
                if (m.id !== `menu-${planId}`) {
                    m.classList.add('hidden');
                }
            });
        }

        function viewPlan(planId) {
            // Implement view plan functionality
            alert('Funcionalidade de visualização será implementada');
        }

        function editPlan(planId) {
            // Implement edit plan functionality
            alert('Funcionalidade de edição será implementada');
        }

        async function deletePlan(planId) {
            if (!confirm('Tem certeza que deseja excluir este plano?')) return;
            
            try {
                const { error } = await supabase
                    .from('lesson_plans')
                    .delete()
                    .eq('id', planId);

                if (error) throw error;

                alert('Plano excluído com sucesso!');
                loadPlans();

            } catch (error) {
                console.error('Erro ao excluir plano:', error);
                alert('Erro ao excluir plano. Tente novamente.');
            }
        }

        function applyFilters() {
            // Implement filter functionality
            loadPlans();
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                window.location.href = './index.html';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('[id^="menu-"]') && !e.target.closest('button[onclick*="togglePlanMenu"]')) {
                document.querySelectorAll('[id^="menu-"]').forEach(menu => {
                    menu.classList.add('hidden');
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'980d052a6479f225',t:'MTc1ODE1ODQyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>




